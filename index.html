<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>æ¯æ—¥ç†±é‡è¨˜éŒ„å™¨</title>
  
  <style>
    body {
      font-family: sans-serif;
      max-width: 700px;
      margin: auto;
      padding: 1em;
      background: url('https://images.unsplash.com/photo-1546069901-eacef0df6022?auto=format&fit=crop&w=1950&q=50') no-repeat center center/cover;
      background-attachment: fixed;
    }
    .container {
      background-color: rgba(255, 255, 255, 0.95);
      padding: 1.5em;
      border-radius: 10px;
      box-shadow: 0 0 10px rgba(0,0,0,0.1);
      max-height: 90vh;
      overflow-y: auto;
    }
    input, select, button {
      margin: 0.5em 0;
      padding: 0.5em;
      box-sizing: border-box;
    }
    .row {
      display: flex;
      gap: 1em;
      align-items: center;
      justify-content: space-between;
      flex-wrap: wrap;
    }
    .row .left {
      flex: 1;
    }
    .row .right {
      flex-shrink: 0;
    }
    .header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 1em;
    }
    .header h2 {
      margin: 0;
    }
    .header button {
      padding: 0.5em 1em;
      width: auto;
    }
    button {
      font-weight: bold;
      cursor: pointer;
      width: 100%;
    }
    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 1em;
      background-color: #fff;
      border-radius: 6px;
      overflow: hidden;
      box-shadow: 0 0 5px rgba(0, 0, 0, 0.1);
    }
    th {
      background-color: #f0f0f0;
      font-weight: bold;
    }
    th, td {
      border: 1px solid #ccc;
      padding: 0.75em;
      text-align: center;
    }
    .total {
      font-weight: bold;
      margin-top: 1em;
    }
    #message, #deleteMsg, #exportMsg {
      font-weight: bold;
      margin-top: 1em;
      text-align: center;
      display: none;
    }
    #message { color: green; }
    #deleteMsg { color: red; }
    #exportMsg { color: #333; }
    .note {
      font-size: 0.9em;
      color: #555;
      margin-bottom: 0.5em;
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="header">
      <h2>ğŸ½ æ¯æ—¥ç†±é‡è¨˜éŒ„å™¨</h2>
      <button onclick="logout()">ç™»å‡º</button>
    </div>

    <label>é£Ÿç‰©åç¨±ï¼š<input type="text" id="foodName" placeholder="ä¾‹å¦‚ï¼šåœ°ç“œã€é›èƒ¸è‚‰" onblur="fetchCalories()"></label>
    <div class="note">å¯è¼¸å…¥å¤šç¨®é£Ÿç‰©ï¼Œè«‹ç”¨é “è™Ÿï¼ˆã€ï¼‰åˆ†éš”</div>
    <label>ç†±é‡ï¼ˆKcalï¼‰ï¼š<input type="number" id="calories" readonly style="background-color:#eee;"> Kcal</label>
    <div class="note"><span style="display:inline-flex; align-items:center; gap:4px;">âš ï¸</span> â€» ç³»çµ±æœƒè‡ªå‹•ä¾ç…§è¼¸å…¥çš„é£Ÿç‰©è¨ˆç®—ç†±é‡ï¼Œç„¡éœ€æ‰‹å‹•è¼¸å…¥ï¼ˆåƒè€ƒè³‡æ–™ä¾†æºï¼šNutritionix APIï¼‰</div>
    <label>é¤åˆ¥ï¼š
      <select id="meal">
        <option value="æ—©é¤">æ—©é¤</option>
        <option value="åˆé¤">åˆé¤</option>
        <option value="æ™šé¤">æ™šé¤</option>
        <option value="é»å¿ƒ">é»å¿ƒ</option>
        <option value="å…¶ä»–">å…¶ä»–</option>
      </select>
    </label>

    <button id="saveBtn" onclick="addEntry()">æ–°å¢ç´€éŒ„</button>
    <button onclick="clearEntries()">æ¸…é™¤æ‰€æœ‰ç´€éŒ„</button>

    <div class="row">
      <div class="left total" id="totalCalories">ç¸½ç†±é‡ï¼š0 Kcal</div>
      <div class="right"><button onclick="exportCSV()">åŒ¯å‡ºç´€éŒ„ CSV</button></div>
    </div>

    <input type="text" id="filterDate" placeholder="ç¯©é¸æ—¥æœŸï¼ˆYYYY/MM/DDï¼‰" oninput="filterEntries()">

    <div id="message">âœ… æ‰€æœ‰ç´€éŒ„å·²æ¸…é™¤</div>
    <div id="deleteMsg">ğŸ—‘ï¸ ç´€éŒ„å·²åˆªé™¤</div>
    <div id="exportMsg">ğŸ“‚ å·²åŒ¯å‡º CSV</div>

    <table id="entryTable">
      <thead>
        <tr>
          <th>æ—¥æœŸæ™‚é–“</th>
          <th>é£Ÿç‰©</th>
          <th>ç†±é‡</th>
          <th>é¤åˆ¥</th>
          <th>æ“ä½œ</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
  </div>

  <script>
    function logout() {
      alert("æ‚¨å·²ç™»å‡ºã€‚");
      window.location.href = "login.html";
    }

    async function fetchCalories() {
      const input = document.getElementById("foodName").value.trim();
      if (!input) return;
      const items = input.split("ã€").map(i => i.trim()).filter(Boolean);
      let total = 0;
      for (const item of items) {
        const res = await fetch(`https://translate.googleapis.com/translate_a/single?client=gtx&sl=zh-TW&tl=en&dt=t&q=${encodeURIComponent(item)}`);
        const json = await res.json();
        const eng = json[0][0][0];
        const nutRes = await fetch("https://trackapi.nutritionix.com/v2/natural/nutrients", {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
            "x-app-id": "8e898936",
            "x-app-key": "226bda0bacff61cd478623317b1c0767"
          },
          body: JSON.stringify({ query: eng })
        });
        const nutJson = await nutRes.json();
        if (nutJson.foods && nutJson.foods.length > 0) {
          total += Math.round(nutJson.foods[0].nf_calories);
        }
      }
      document.getElementById("calories").value = total;
    }

    function addEntry() {
      const food = document.getElementById("foodName").value.trim();
      const kcal = document.getElementById("calories").value;
      const meal = document.getElementById("meal").value;
      const time = new Date().toLocaleString();
      if (!food || !kcal) return;

      const table = document.querySelector("#entryTable tbody");
      const row = document.createElement("tr");
      row.innerHTML = `
        <td>${time}</td>
        <td>${food}</td>
        <td>${kcal}</td>
        <td>${meal}</td>
        <td>
          <button onclick="this.closest('tr').remove(); updateTotal();">åˆªé™¤</button>
        </td>
      `;
      table.appendChild(row);

      updateTotal();
      document.getElementById("foodName").value = "";
      document.getElementById("calories").value = "";
    }

    function updateTotal() {
      let total = 0;
      document.querySelectorAll("#entryTable tbody tr").forEach(row => {
        total += parseInt(row.children[2].textContent);
      });
      document.getElementById("totalCalories").textContent = `ç¸½ç†±é‡ï¼š${total} Kcal`;
    }

    function clearEntries() {
      document.querySelector("#entryTable tbody").innerHTML = "";
      updateTotal();
    }

    function exportCSV() {
      let csv = "æ—¥æœŸæ™‚é–“,é£Ÿç‰©,ç†±é‡,é¤åˆ¥
";
      document.querySelectorAll("#entryTable tbody tr").forEach(row => {
        const cells = Array.from(row.children).slice(0, 4).map(td => td.textContent);
        csv += cells.join(",") + "
";
      });
      const blob = new Blob([csv], { type: 'text/csv' });
      const url = URL.createObjectURL(blob);
      const link = document.createElement('a');
      link.href = url;
      link.download = "calorie_records.csv";
      link.click();
    }

    function filterEntries() {
      const keyword = document.getElementById("filterDate").value.trim();
      document.querySelectorAll("#entryTable tbody tr").forEach(row => {
        row.style.display = row.children[0].textContent.startsWith(keyword) ? "" : "none";
      });
    }
  </script>
</body>
</html>

</html>
